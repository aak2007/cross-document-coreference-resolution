package edu.oregonstate.dataset;

import java.util.List;
import java.util.Properties;

import edu.oregonstate.experiment.ExperimentConstructor;
import edu.oregonstate.featureExtractor.SrlResultIncorporation;
import edu.oregonstate.dataset.IDataSet;
import edu.oregonstate.io.ResultOutput;
import edu.stanford.nlp.dcoref.CorefCluster;
import edu.stanford.nlp.dcoref.Document;
import edu.stanford.nlp.dcoref.Mention;

/**
 * Based on the topic Document object, incorporate the SRL predicate and their arguments 
 * with the predicted mentions generated by Rule based mention detection component.
 * 
 * @author Jun Xie (xie@eecs.oregonstate.edu)
 *
 */

public class CrossTopic implements IDataSet {

	/** corpus path */
	private final String dataPath;

	/* srl path */
	private final String srlPath;

	/* Log File Path */
	private final String logFile;

	/* experiment properties file */
	private final Properties mProps;

	/* experiment result folder */
	private final String experimentResultFolder;

	/* corpus path */
	private final String corpusPath;

	/** used for scoring */
	//private static final Logger logger = Logger.getLogger(WithinCross.class.getName());

	public CrossTopic() {
		mProps = ExperimentConstructor.experimentProps;
		logFile = ExperimentConstructor.logFile;
		experimentResultFolder = ExperimentConstructor.experimentResultFolder;
		corpusPath = ExperimentConstructor.corpusPath;
		dataPath = corpusPath + "corpus/EECB1.0/data/";
		srlPath = corpusPath + "corpus/tokenoutput/";
	}

	@Override
	public Document getData(String topic, boolean goldOnly) {
		String currentExperimentFolder = experimentResultFolder + "/" + topic;
		String statisticsPath = currentExperimentFolder + "/" + "statistics";

		Document document = new Document();

		try{
			String path = dataPath + topic + "/";
			ResultOutput.writeTextFile(ExperimentConstructor.logFile, topic + " : " + path);
			document = getDocument(topic, goldOnly);
			ResultOutput.writeTextFile(statisticsPath, topic + " " + document.allGoldMentions.size() + " " + document.goldCorefClusters.size() + " " + document.allPredictedMentions.size() + " " +
					document.corefClusters.size());

			document.setID(topic);
			document.fill();                                // incorporate SYNONYM
			srlIncorporation(topic, document.predictedOrderedMentionsBySentence, srlPath);

			// generate feature for each mention
			for (Integer id : document.corefClusters.keySet()) {
				CorefCluster cluster = document.corefClusters.get(id);
				cluster.regenerateFeature();
			}

		} catch (Exception e) {
			throw new RuntimeException(e);
		}

		return document;
	}
	
	/**
	 * incorporate the srl result with the document predicted mentions
	 * 
	 * @param topic
	 * @param predictedOrderedMentionsBySentence
	 * @param srlPath
	 */
	private void srlIncorporation(String topic, List<List<Mention>> predictedOrderedMentionsBySentence, String srlPath) {
		SrlResultIncorporation srlResult = new SrlResultIncorporation(srlPath + topic + ".output");
		srlResult.alignSRL(predictedOrderedMentionsBySentence);
	}
	
	/** treat the topic as a whole */
	private Document getDocument(String path, boolean goldOnly) {
		CorefSystem cs = new CorefSystem();
		Document document = new Document();
		try {
			document = cs.getDocument(path, goldOnly);
			cs.getCorefSystem().coref(document);
		} catch (Exception e) {
			throw new RuntimeException(e);
		}
		
		return document;
	}
	
}
